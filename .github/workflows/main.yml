name: Fetch JSON Data

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fetch-json:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Fetch JSON data
        run: |
          WHITEBOARD_ID=$(grep -oP "'whiteboard_id':\s*'\K[^']+" src/config.js | head -n1)
          if [[ -z "${WHITEBOARD_ID}" ]]; then
            echo "Cannot resolve whiteboard_id from config.js"
            exit 1
          fi

          echo "Using whiteboard_id: ${WHITEBOARD_ID}"
          URLS=(
            "https://heptabase-api-five.vercel.app/?whiteboard_id=${WHITEBOARD_ID}"
          )

          SUCCESS=0
          for URL in "${URLS[@]}"; do
            echo "Trying: ${URL}"
            if curl -fL --connect-timeout 15 --max-time 60 "${URL}" -o /tmp/data.json; then
              if jq -e '((.code == 0) or (.code == 200) or (.code == null)) and (.data.cards | type == "array")' /tmp/data.json > /dev/null; then
                SUCCESS=1
                break
              else
                echo "Response format invalid, trying next endpoint..."
              fi
            else
              echo "Request failed, trying next endpoint..."
            fi
          done

          if [ "${SUCCESS}" -ne 1 ]; then
            echo "All endpoints failed or returned invalid data."
            exit 1
          fi

          mv /tmp/data.json src/resources/data.json

      - name: Save JSON data to repository
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "GitHub Actions"
          git checkout main
          git add src/resources/data.json
          git diff --cached --quiet && exit 0
          git commit -m "Update data.json"
          git push origin main
